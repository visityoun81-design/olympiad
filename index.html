<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="apple-touch-icon" href="icon.PNG">
    <link rel="icon" href="icon.PNG">
    <meta charset="UTF-8">
    <title>올림피아드</title>
    <style>
        :root {
            --primary-color: #39FF14;
            --bg-color: #0a0a0a;
            --card-bg: #1a1a1a;
            --danger-color: #ff4d4d;
        }

        body { 
            background-color: var(--bg-color); 
            color: var(--primary-color); 
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100vh; margin: 0; overflow: hidden; 
        }
        
        #game-container {
            display: none; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 100%; position: relative;
        }

        /* 메인 시작 화면 */
        #main-screen {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }

        #main-title { font-size: 24px; color: #888; margin-bottom: 15px; letter-spacing: 3px; font-weight: 300; }
        #main-sub { font-size: 50px; color: #fff; margin-bottom: 50px; font-weight: 700; text-shadow: 0 0 20px rgba(255,255,255,0.1); }

        #info { font-size: 32px; color: #aaaaaa; height: 40px; margin-bottom: 20px; font-weight: 300; }
        
        #flash-display { 
            font-size: 240px; font-weight: 400; height: 280px; 
            display: flex; align-items: center; justify-content: center;
            text-shadow: 0 0 15px rgba(57, 255, 20, 0.15);
        }
        
        #input-area { display: none; text-align: center; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .input-label { font-size: 30px; color: #ffffff; margin-bottom: 20px; font-weight: 300; }
        
        .input-wrapper {
            background: var(--card-bg); border: 2px solid #333; border-radius: 16px;
            padding: 15px 40px; box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .input-wrapper:focus-within { border-color: var(--primary-color); box-shadow: 0 0 25px rgba(57, 255, 20, 0.25); transform: scale(1.02); }

        input { background: transparent; border: none; color: white; font-size: 85px; width: 320px; text-align: center; outline: none; font-weight: 300; }
        
        /* 결과 리포트 */
        #result-view { 
            display: none; width: 80%; max-height: 85vh; overflow-y: auto; 
            border-radius: 24px; border: 1px solid #333; padding: 45px; 
            background: var(--card-bg); text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }
        
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th { color: #888; font-weight: 400; padding: 18px; border-bottom: 2px solid #333; font-size: 18px; }
        td { padding: 18px; font-size: 22px; border-bottom: 1px solid #222; }
        .wrong { color: var(--danger-color); text-decoration: line-through; opacity: 0.6; }
        
        /* 버튼 스타일 */
        .btn { cursor: pointer; transition: all 0.3s; font-family: inherit; }
        #startBtn { 
            padding: 22px 80px; font-size: 28px; background: transparent; 
            color: var(--primary-color); border: 2px solid var(--primary-color); 
            border-radius: 100px; font-weight: 500;
        }
        #startBtn:hover { background: var(--primary-color); color: black; box-shadow: 0 0 40px rgba(57, 255, 20, 0.5); }

        /* 그만하기 버튼 (우측 하단) */
        #stopBtn {
            position: fixed; bottom: 30px; right: 30px;
            padding: 12px 25px; font-size: 18px; background: #222;
            color: #888; border: 1px solid #444; border-radius: 8px;
        }
        #stopBtn:hover { background: var(--danger-color); color: white; border-color: var(--danger-color); }
    </style>
</head>
<body>

    <div id="main-screen">
        <div id="main-title">올림피아드 플래쉬암산 연습</div>
        <div id="main-sub">암산 챌린지</div>
        <button id="startBtn" class="btn">연습 시작하기</button>
    </div>

    <div id="game-container">
        <div id="info"></div>
        <div id="flash-display"></div>
        <div id="input-area">
            <div class="input-label">답을 입력하세요</div>
            <div class="input-wrapper">
                <input type="number" id="answerInput" autocomplete="off">
            </div>
        </div>
        <button id="stopBtn" class="btn" onclick="terminateGame()">그만하기</button>
    </div>

    <div id="result-view">
        <p style="color: #aaaaaa; margin: 0; font-size: 20px; letter-spacing: 2px;">연습 결과 리포트</p>
        <h1 id="total-score" style="color:white; font-size: 60px; margin: 10px 0 40px 0;"></h1>
        <table id="result-table">
            <thead><tr><th>문제</th><th>정답</th><th>입력한 답</th><th>판정</th></tr></thead>
            <tbody id="result-body"></tbody>
        </table>
        <button onclick="location.reload()" style="margin-top:45px; padding:18px 45px; background: #333; color: white; border: none; border-radius: 12px; cursor:pointer; font-size: 18px;" class="btn">다시 시작하기</button>
    </div>

    <script>
        let audioCtx;
        let results = [];
        let isTerminated = false;
        let currentQNum = 1;

        function playSound(freq, type, dur, vol) {
            if(!audioCtx || isTerminated) return;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + dur);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + dur);
        }

        const stages = [
            {n:1, d:1, r:3, t:1000, type:'+'}, {n:4, d:1, r:5, t:1000, type:'+'},
            {n:5, d:1, r:5, t:900,  type:'+'}, {n:7, d:1, r:5, t:800,  type:'+'},
            {n:8, d:1, r:5, t:800,  type:'-'}, {n:11, d:2, r:5, t:800,  type:'+'},
            {n:12, d:2, r:5, t:800,  type:'-'}, {n:14, d:2, r:7, t:700,  type:'+'},
            {n:15, d:2, r:7, t:700,  type:'-'}, {n:19, d:3, r:7, t:600,  type:'+'},
            {n:20, d:3, r:7, t:600,  type:'-'}, {n:23, d:3, r:10,t:500,  type:'+'}
        ];

        function getLevel(q) {
            let res = stages[0];
            for(let s of stages) if(q >= s.n) res = s;
            return res;
        }

        document.getElementById('startBtn').addEventListener('click', function() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'flex';
            runGame();
        });

        async function runGame() {
            for(currentQNum = 1; currentQNum <= 25; currentQNum++) {
                if(isTerminated) break;
                await runQuest(currentQNum);
            }
            showResult();
        }

        async function runQuest(qNum) {
            if(isTerminated) return;
            const level = getLevel(qNum);
            const info = document.getElementById('info');
            const display = document.getElementById('flash-display');
            const inputArea = document.getElementById('input-area');
            const input = document.getElementById('answerInput');

            info.innerText = `${qNum}번 문제`;
            display.innerText = "";
            inputArea.style.display = "none";
            playSound(880, 'sine', 0.4, 0.05); 
            await new Promise(r => {
                const timer = setTimeout(r, 800);
                if(isTerminated) clearTimeout(timer);
            });
            
            if(isTerminated) return;
            info.innerText = ""; 

            let sum = 0;
            for(let i=0; i<level.r; i++) {
                if(isTerminated) break;
                let n = Math.floor(Math.random() * (Math.pow(10, level.d) - Math.pow(10, level.d-1))) + Math.pow(10, level.d-1);
                let prefix = "";
                if(level.type === '-' && i > 0 && Math.random() > 0.4 && sum > n) { 
                    n = -n; prefix = "-"; 
                }
                sum += n;

                display.innerText = (n < 0) ? prefix + Math.abs(n) : n;
                playSound(600, 'square', 0.05, 0.03); 
                await new Promise(r => setTimeout(r, level.t));
                display.innerText = "";
                await new Promise(r => setTimeout(r, 50));
            }

            if(isTerminated) return;
            inputArea.style.display = "block";
            input.value = "";
            input.focus();

            for(let i=0; i<6; i++) {
                if(isTerminated) break;
                playSound(i % 2 === 0 ? 1000 : 700, 'sine', 0.05, 0.02);
                await new Promise(r => setTimeout(r, 500));
            }
            if(!isTerminated) {
                results.push({ q: qNum, ans: sum, user: parseInt(input.value) || 0 });
            }
        }

        function terminateGame() {
            isTerminated = true;
            showResult();
        }

        function showResult() {
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('main-screen').style.display = 'none';
            document.getElementById('result-view').style.display = 'block';
            
            let correct = 0;
            const tbody = document.getElementById('result-body');
            tbody.innerHTML = "";

            // 1번부터 25번까지 전체 결과 생성
            for(let i = 1; i <= 25; i++) {
                let r = results.find(res => res.q === i);
                const row = tbody.insertRow();
                
                if (r) {
                    // 이미 푼 문제 채점
                    const isOk = r.ans === r.user;
                    if(isOk) correct++;
                    row.innerHTML = `<td>${i}번</td><td>${r.ans}</td><td class="${isOk?'':'wrong'}">${r.user}</td><td>${isOk?'<span style="color:var(--primary-color)">정답</span>':'<span style="color:var(--danger-color)">오답</span>'}</td>`;
                } else {
                    // 안 푼 문제는 오답 처리
                    row.innerHTML = `<td>${i}번</td><td>-</td><td class="wrong">미풀이</td><td><span style="color:var(--danger-color)">오답</span></td>`;
                }
            }
            document.getElementById('total-score').innerText = `${correct} / 25점`;
        }
    </script>
</body>
</html>
